<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±Ø© - Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ø³ØªØ¦Ø°Ø§Ù†</title>
<style>
    * {margin:0;padding:0;box-sizing:border-box;}
    body {font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; padding:20px; color:#333;}
    .container {max-width:1400px;margin:0 auto;}
    .header {background:white;padding:30px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.2);margin-bottom:30px;text-align:center;}
    .header h1 {color:#667eea;font-size:2.5em;margin-bottom:10px;}
    .header p {color:#666;font-size:1.1em;}
    .stats {display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px;}
    .stat-card {background:white;padding:25px;border-radius:12px;box-shadow:0 5px 15px rgba(0,0,0,0.1);text-align:center;cursor:pointer;transition:0.3s;}
    .stat-card:hover {transform:translateY(-5px);}
    .stat-card h3 {font-size:2.5em;color:#667eea;margin-bottom:10px;}
    .stat-card p {color:#666;font-size:1.1em;}
    .requests-container {background:white;padding:30px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.2);}
    .filter-buttons {display:flex;gap:15px;margin-bottom:25px;flex-wrap:wrap;}
    .filter-btn {padding:12px 25px;border:none;border-radius:8px;font-size:1em;cursor:pointer;transition:all 0.3s;font-weight:bold;}
    .filter-btn.active {background:#667eea;color:white;box-shadow:0 5px 15px rgba(102,126,234,0.4);}
    .filter-btn:not(.active){background:#f0f0f0;color:#666;}
    .filter-btn:hover {transform:translateY(-2px);}
    .request-card {background:#f9f9f9;padding:25px;border-radius:12px;margin-bottom:20px;border-right:5px solid #667eea;transition:0.5s;}
    .request-card.removing {opacity:0;transform:translateX(-100px);height:0;padding:0;margin:0;overflow:hidden;}
    .request-card:hover {box-shadow:0 5px 20px rgba(0,0,0,0.1);transform:translateX(-5px);}
    .request-header {display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;flex-wrap:wrap;gap:10px;}
    .student-info h3 {color:#333;font-size:1.5em;margin-bottom:5px;}
    .student-info p {color:#666;font-size:0.95em;}
    .status-badge {padding:8px 20px;border-radius:20px;font-weight:bold;font-size:0.9em;}
    .status-pending {background:#ffeaa7;color:#d63031;}
    .status-approved {background:#55efc4;color:#00b894;}
    .status-rejected {background:#ff7675;color:#d63031;}
    .request-details {background:white;padding:15px;border-radius:8px;margin-bottom:15px;}
    .detail-row {display:flex;margin-bottom:10px;font-size:1em;}
    .detail-label {font-weight:bold;color:#667eea;min-width:150px;}
    .detail-value {color:#333;flex:1;}
    .action-buttons {display:flex;gap:15px;flex-wrap:wrap;}
    .btn {padding:12px 30px;border:none;border-radius:8px;font-size:1em;cursor:pointer;transition:all 0.3s;font-weight:bold;}
    .btn:disabled {opacity:0.5;cursor:not-allowed;}
    .btn-approve {background:#00b894;color:white;}
    .btn-approve:hover:not(:disabled) {background:#00a085;transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,184,148,0.3);}
    .btn-reject {background:#d63031;color:white;}
    .btn-reject:hover:not(:disabled) {background:#c0281f;transform:translateY(-2px);box-shadow:0 5px 15px rgba(214,48,49,0.3);}
    .modal {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:1000;justify-content:center;align-items:center;}
    .modal.active {display:flex;}
    .modal-content {background:white;padding:40px;border-radius:15px;max-width:500px;width:90%;box-shadow:0 10px 50px rgba(0,0,0,0.3);}
    .modal-content h2 {color:#667eea;margin-bottom:20px;font-size:1.8em;}
    .modal-content textarea {width:100%;padding:15px;border:2px solid #ddd;border-radius:8px;font-size:1em;min-height:120px;font-family:inherit;resize:vertical;}
    .modal-content textarea:focus {outline:none;border-color:#667eea;}
    .modal-buttons {display:flex;gap:15px;margin-top:20px;}
    .btn-confirm {flex:1;background:#667eea;color:white;}
    .btn-cancel {flex:1;background:#ddd;color:#333;}
    .loading {text-align:center;padding:40px;font-size:1.2em;color:#667eea;}
    .no-requests {text-align:center;padding:60px;color:#999;font-size:1.3em;}
    .refresh-btn {position:fixed;bottom:30px;left:30px;width:60px;height:60px;border-radius:50%;background:#667eea;color:white;border:none;font-size:1.5em;cursor:pointer;box-shadow:0 5px 20px rgba(102,126,234,0.4);transition:all 0.3s;}
    .refresh-btn:hover {transform:rotate(180deg) scale(1.1);}
    .toast {position:fixed;top:20px;right:20px;background:white;padding:20px 30px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.3);z-index:2000;display:none;animation:toastIn 0.3s ease;}
    .toast.show {display:block;}
    .toast.success {border-right:4px solid #00b894;}
    .toast.error {border-right:4px solid #d63031;}
    @keyframes toastIn {from{transform:translateX(400px);opacity:0;}to{transform:translateX(0);opacity:1;}}
    @media (max-width:768px){.header h1{font-size:1.8em;}.request-header{flex-direction:column;align-items:flex-start;}.detail-row{flex-direction:column;}.detail-label{min-width:auto;margin-bottom:5px;}}
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ğŸ« Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ø³ØªØ¦Ø°Ø§Ù†</h1>
        <p>Ø¥Ø¯Ø§Ø±Ø© ÙˆÙ…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ø³ØªØ¦Ø°Ø§Ù† Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© Ù…Ù† Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±</p>
    </div>

    <div class="stats">
        <div class="stat-card" onclick="filterByStatus('all')">
            <h3 id="total-count">0</h3>
            <p>ğŸ“‹ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>
        </div>
        <div class="stat-card" onclick="filterByStatus('Pending')">
            <h3 id="pending-count">0</h3>
            <p>â³ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</p>
        </div>
        <div class="stat-card" onclick="filterByStatus('Approved')">
            <h3 id="approved-count">0</h3>
            <p>âœ… ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„</p>
        </div>
        <div class="stat-card" onclick="filterByStatus('Rejected')">
            <h3 id="rejected-count">0</h3>
            <p>âŒ ØªÙ… Ø§Ù„Ø±ÙØ¶</p>
        </div>
    </div>

    <div class="requests-container">
        <div class="filter-buttons">
            <button class="filter-btn active" data-filter="all">ğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
            <button class="filter-btn" data-filter="Pending">â³ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
            <button class="filter-btn" data-filter="Approved">âœ… Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø©</button>
            <button class="filter-btn" data-filter="Rejected">âŒ Ø§Ù„Ù…Ø±ÙÙˆØ¶Ø©</button>
        </div>
        <div id="requests-list">
            <div class="loading">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</div>
        </div>
    </div>
</div>

<button class="refresh-btn" onclick="loadRequests()">ğŸ”„</button>

<div id="modal" class="modal">
    <div class="modal-content">
        <h2 id="modal-title">Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø©</h2>
        <textarea id="modal-textarea" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ù†Ø§..."></textarea>
        <div class="modal-buttons">
            <button class="btn btn-confirm" onclick="confirmAction()">âœ… ØªØ£ÙƒÙŠØ¯</button>
            <button class="btn btn-cancel" onclick="closeModal()">âŒ Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<div id="toast" class="toast">
    <span id="toast-message"></span>
</div>

<script>
const N8N_API_URL = 'https://n8n.srv1096584.hstgr.cloud/webhook';
let allRequests = [];
let currentFilter = 'all';
let currentAction = null;
let currentRequestId = null;

window.onload = function() {
    loadRequests();
    setupFilters();
};

function setupFilters() {
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentFilter = this.getAttribute('data-filter');
            displayRequests();
        });
    });
}

function filterByStatus(status) {
    currentFilter = status;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    const btn = document.querySelector(`[data-filter="${status}"]`);
    if (btn) btn.classList.add('active');
    displayRequests();
}

async function loadRequests() {
    try {
        const response = await fetch(N8N_API_URL + '/admin/get-requests');
        const data = await response.json();
        allRequests = data.requests || [];
        updateStats();
        displayRequests();
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
        document.getElementById('requests-list').innerHTML = '<div class="no-requests">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>';
    }
}

function updateStats() {
    const total = allRequests.length;
    const pending = allRequests.filter(r => r.status === 'Pending').length;
    const approved = allRequests.filter(r => r.status === 'Approved').length;
    const rejected = allRequests.filter(r => r.status === 'Rejected').length;
    document.getElementById('total-count').textContent = total;
    document.getElementById('pending-count').textContent = pending;
    document.getElementById('approved-count').textContent = approved;
    document.getElementById('rejected-count').textContent = rejected;
}
function formatDate(dateStr) {
  if (!dateStr) return 'â€”'; // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® ÙØ§Ø¶ÙŠ
  const parts = dateStr.split(/[-\/\s:]/);
  // Ù†Ø­Ø§ÙˆÙ„ Ù†ÙÙ‡Ù… Ø§Ù„ØªØ§Ø±ÙŠØ® Ø³ÙˆØ§Ø¡ ÙƒØ§Ù† Ø¨ØµÙŠØºØ© ÙŠÙˆÙ…/Ø´Ù‡Ø±/Ø³Ù†Ø© Ø£Ùˆ Ø³Ù†Ø©-Ø´Ù‡Ø±-ÙŠÙˆÙ…
  if (parts.length >= 3) {
    let year, month, day, hour = 0, minute = 0;
    if (parts[0].length === 4) {
      // ØµÙŠØºØ© Ø³Ù†Ø©-Ø´Ù‡Ø±-ÙŠÙˆÙ…
      [year, month, day] = parts;
    } else {
      // ØµÙŠØºØ© ÙŠÙˆÙ…/Ø´Ù‡Ø±/Ø³Ù†Ø©
      [day, month, year] = parts;
    }
    const date = new Date(year, month - 1, day, hour, minute);
    return date.toLocaleString('ar-SA');
  }
  return dateStr; // fallback Ù„Ùˆ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ ØºØ±ÙŠØ¨
}
function formatDate(dateStr) {
  if (!dateStr) return 'â€”';
  const parsed = Date.parse(dateStr);
  if (isNaN(parsed)) return 'â€”';
  return new Date(parsed).toLocaleString('ar-SA', {
    dateStyle: 'short',
    timeStyle: 'short'
  });
}

function displayRequests() {
    const container = document.getElementById('requests-list');
    let filteredRequests = allRequests;
    if (currentFilter !== 'all') filteredRequests = allRequests.filter(r => r.status === currentFilter);
    filteredRequests.sort((a,b)=> a.status==='Pending'? -1:1);

    if(filteredRequests.length===0){
        container.innerHTML='<div class="no-requests">ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</div>';
        return;
    }

    container.innerHTML = filteredRequests.map(request=>{
        const statusClass = request.status.toLowerCase();
        const statusText = {'Pending':'â³ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©','Approved':'âœ… ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„','Rejected':'âŒ ØªÙ… Ø§Ù„Ø±ÙØ¶'}[request.status]||request.status;
        return `
        <div class="request-card" id="card-${request.requestId}">
            <div class="request-header">
                <div class="student-info">
                    <h3>ğŸ‘¤ ${request.studentName}</h3>
                    <p>Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨: ${request.studentId} | Ø§Ù„ØµÙ: ${request.grade} - ${request.section}</p>
                </div>
                <span class="status-badge status-${statusClass}">${statusText}</span>
            </div>
            <div class="request-details">
                <div class="detail-row"><span class="detail-label">ğŸ“‹ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</span><span class="detail-value">${request.requestId}</span></div>
                <div class="detail-row"><span class="detail-label">ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:</span><span class="detail-value">${request.phone}</span></div>
                <div class="detail-row"><span class="detail-label">ğŸ“ Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø³ØªØ¦Ø°Ø§Ù†:</span><span class="detail-value">${request.reason}</span></div>
                <div class="detail-row"><span class="detail-label">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨:</span><span class="detail-value">${formatDate(request.datetime)}
</span></div>
                ${request.adminResponse? `<div class="detail-row"><span class="detail-label">ğŸ’¬ Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ù…Ø¯ÙŠØ±Ø©:</span><span class="detail-value">${request.adminResponse}</span></div>` : ''}
                ${request.responseDate? `<div class="detail-row"><span class="detail-label">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±Ø¯:</span><span class="detail-value">${formatDate(request.responseDate)}
</span></div>`: ''}
            </div>
            ${request.status==='Pending'? `
            <div class="action-buttons">
                <button class="btn btn-approve" onclick="updateStatus('approve','${request.requestId}')">âœ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨</button>
                <button class="btn btn-reject" onclick="updateStatus('reject','${request.requestId}')">âŒ Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨</button>
            </div>`: ''}
        </div>`;
    }).join('');
}

async function updateStatus(action, requestId){
    const card = document.getElementById(`card-${requestId}`);
    const requestIndex = allRequests.findIndex(r=>r.requestId===requestId);
    if(requestIndex===-1) return;

    const response = prompt(action==='approve'? 'Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):':'Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶:');
    if(action==='reject' && !response){alert('âš ï¸ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ');return;}

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© ÙÙˆØ±Ø§Ù‹
    allRequests[requestIndex].status = action==='approve'?'Approved':'Rejected';
    allRequests[requestIndex].adminResponse = response;
    allRequests[requestIndex].responseDate = new Date().toISOString();
    displayRequests();
    updateStats();

    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± WhatsApp Ø¹Ø¨Ø± n8n
    try{
        await fetch(N8N_API_URL+'/admin/update-request',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({requestId, action, adminResponse:response})
        });
    }catch(e){console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:',e);}
    showToast(action==='approve'?'âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±':'âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±','success');
}

function showToast(msg,type='success'){
    const toast=document.getElementById('toast');
    document.getElementById('toast-message').textContent=msg;
    toast.className=`toast ${type} show`;
    setTimeout(()=>{toast.classList.remove('show');},3000);
}

</script>
</body>
</html>
