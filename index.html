<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>📋 لوحة طلبات الاستئذان - النظام الإداري</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    body { font-family: "Tajawal", sans-serif; background-color: #f8fafc; }
    .fade-in { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-7xl mx-auto p-6">
    <!-- Header -->
    <div class="flex flex-col md:flex-row items-center justify-between mb-6">
      <div>
        <h1 class="text-3xl font-extrabold text-indigo-700 mb-1">📋 لوحة طلبات الاستئذان</h1>
        <p class="text-gray-600">إدارة ومراجعة طلبات الطلاب من Google Sheets</p>
      </div>
      <button id="refresh-btn" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg transition-all font-medium shadow-md">
        <i data-lucide="refresh-ccw" class="w-5 h-5"></i> تحديث البيانات
      </button>
    </div>

    <!-- Stats -->
    <div id="stats" class="flex flex-wrap justify-center gap-4 mb-6"></div>

    <!-- Filter Buttons -->
    <div class="flex justify-center gap-2 mb-6">
      <button class="filter-btn bg-indigo-600 text-white px-4 py-2 rounded-lg font-medium" data-filter="all">الكل</button>
      <button class="filter-btn bg-gray-200 px-4 py-2 rounded-lg font-medium" data-filter="Pending">قيد الانتظار</button>
      <button class="filter-btn bg-gray-200 px-4 py-2 rounded-lg font-medium" data-filter="Approved">موافق عليها</button>
      <button class="filter-btn bg-gray-200 px-4 py-2 rounded-lg font-medium" data-filter="Rejected">مرفوضة</button>
    </div>

    <!-- Error + Loading -->
    <p id="error" class="text-red-600 text-center font-semibold"></p>
    <div id="loading" class="text-center text-indigo-700 font-semibold mb-3 hidden">⏳ جاري تحميل البيانات...</div>

    <!-- Table -->
    <div class="overflow-x-auto shadow-lg rounded-lg bg-white fade-in">
      <table class="min-w-full text-sm text-right text-gray-700">
        <thead class="bg-indigo-100">
          <tr>
            <th class="py-3 px-4">اسم الطالب</th>
            <th class="py-3 px-4">رقم الطالب</th>
            <th class="py-3 px-4">الصف</th>
            <th class="py-3 px-4">الفصل</th>
            <th class="py-3 px-4">الجوال</th>
            <th class="py-3 px-4">السبب</th>
            <th class="py-3 px-4">التاريخ</th>
            <th class="py-3 px-4">الحالة</th>
            <th class="py-3 px-4">إجراء</th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>
  </div>

  <script>
    lucide.createIcons();

    const sheetId = "1im7B1quJaICfownQ9Lbky7jDSNCd_N5EYRAx3H_UdRg";
    const gid = "0";
    const sheetUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=${gid}`;

    const tableBody = document.getElementById('table-body');
    const statsEl = document.getElementById('stats');
    const loadingEl = document.getElementById('loading');
    const errorEl = document.getElementById('error');
    const refreshBtn = document.getElementById('refresh-btn');
    const filterBtns = document.querySelectorAll('.filter-btn');
    let allRequests = [];
    let currentFilter = 'all';

    async function fetchData() {
      loadingEl.classList.remove('hidden');
      tableBody.innerHTML = '';
      try {
        const res = await fetch(sheetUrl);
        const text = await res.text();
        const jsonText = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
        const data = JSON.parse(jsonText).table.rows;
        
        allRequests = data.map(r => ({
          studentName: r.c[1]?.v || '',
          studentId: r.c[2]?.v || '',
          grade: r.c[3]?.v || '',
          section: r.c[4]?.v || '',
          phone: r.c[5]?.v || '',
          reason: r.c[6]?.v || '',
          datetime: r.c[7]?.v || '',
          status: r.c[8]?.v || 'Pending',
        }));

        updateDashboard();
      } catch (err) {
        errorEl.textContent = '⚠️ حدث خطأ أثناء تحميل البيانات: ' + err.message;
      } finally {
        loadingEl.classList.add('hidden');
      }
    }

    function updateDashboard() {
      let filtered = allRequests;
      if (currentFilter !== 'all') filtered = allRequests.filter(r => r.status === currentFilter);

      const total = allRequests.length;
      const pending = allRequests.filter(r => r.status === 'Pending').length;
      const approved = allRequests.filter(r => r.status === 'Approved').length;
      const rejected = allRequests.filter(r => r.status === 'Rejected').length;

      statsEl.innerHTML = `
        <div class="bg-yellow-100 text-yellow-800 px-6 py-3 rounded-xl shadow-md">قيد الانتظار: <b>${pending}</b></div>
        <div class="bg-green-100 text-green-800 px-6 py-3 rounded-xl shadow-md">موافق عليها: <b>${approved}</b></div>
        <div class="bg-red-100 text-red-800 px-6 py-3 rounded-xl shadow-md">مرفوضة: <b>${rejected}</b></div>
        <div class="bg-blue-100 text-blue-800 px-6 py-3 rounded-xl shadow-md">الإجمالي: <b>${total}</b></div>
      `;

      tableBody.innerHTML = filtered.map(r => `
        <tr class="border-b hover:bg-gray-50 transition">
          <td class="py-3 px-4 font-bold">${r.studentName}</td>
          <td class="py-3 px-4">${r.studentId}</td>
          <td class="py-3 px-4">${r.grade}</td>
          <td class="py-3 px-4">${r.section}</td>
          <td class="py-3 px-4">${r.phone}</td>
          <td class="py-3 px-4">${r.reason}</td>
          <td class="py-3 px-4">${r.datetime}</td>
          <td class="py-3 px-4">
            ${r.status === 'Pending' ? '<span class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-sm">قيد الانتظار</span>' :
              r.status === 'Approved' ? '<span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm">موافق عليه</span>' :
              '<span class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-sm">مرفوض</span>'}
          </td>
          <td class="py-3 px-4 flex gap-2">
            ${r.status === 'Pending' ? `
              <button onclick="approveRequest('${r.studentId}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-lg text-sm flex items-center gap-1">
                <i data-lucide='check'></i> موافقة
              </button>
              <button onclick="rejectRequest('${r.studentId}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-sm flex items-center gap-1">
                <i data-lucide='x'></i> رفض
              </button>
            ` : '-'}
          </td>
        </tr>
      `).join('');
      lucide.createIcons();
    }

    function approveRequest(id) {
      alert(`✅ تمت الموافقة على طلب الطالب ${id}`);
    }

    function rejectRequest(id) {
      alert(`❌ تم رفض طلب الطالب ${id}`);
    }

    refreshBtn.addEventListener('click', fetchData);
    filterBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        currentFilter = btn.dataset.filter;
        filterBtns.forEach(b => b.classList.remove('bg-indigo-600', 'text-white'));
        btn.classList.add('bg-indigo-600', 'text-white');
        updateDashboard();
      });
    });

    fetchData();
  </script>
</body>
</html>
